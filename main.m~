%% main
load('data.mat');

filtered_s = dsnew();
normalized_s = dsnew();
total_features = 0;
chosen_features_num = 4;



%% filter data

for s_id = 1:3                          %for each sensor
    for a_id = 1:4                      %for each actovity
        for v_id  = 1:10                %for each volunteer
            fs = sgolayfilt(dsget(data,s_id,a_id,v_id),4,21);
            filtered_s = dsput(filtered_s,fs,s_id,a_id,v_id);
        end
    end
end

%plot(dsget(data,1,1,1));
%hold on 
%plot(dsget(filtered_s,1,1,1));

%% subtract mean value

for s_id = 1:3
    for a_id = 1:4
        for v_id = 1:10
            ds = detrend(dsget(filtered_s, s_id, a_id, v_id),'constant');
            filtered_s = dsput(filtered_s,ds, s_id,a_id,v_id);
        end
    end
end

%plot(dsget(filtered_s,1,1,1));


%% z-normalization

for s_id = 1:3
    for a_id = 1:4
        for v_id = 1:10
            s = dsget(filtered_s,s_id,a_id,v_id);
            %compute standard deviation for each signal
            standard_dev = std(s);
            %divide the signal for the standard deviation
            normalized_signal = s/standard_dev;
            normalized_s = dsput(normalized_s, normalized_signal, s_id,...
                a_id, v_id);     
        end
    end
end

%plot(dsget(normalized_s,1,1,1));

%% extract features for each sensor
features_ds = dsnew();

for s_id = 1:3
    for a_id = 1:4
        for v_id = 1:10
            feat_t = getfeatures(dsget(normalized_s,s_id,a_id,v_id), 't');
            feat_f = getfeatures(dsget(normalized_s,s_id,a_id,v_id), 'f');
            feat = [feat_t, feat_f];
            total_features = length(feat);
            features_ds = dsputfeatures(features_ds,feat,s_id,a_id,v_id);
        end
    end
end

%% create and train neural nwtworks (4 features)

targets = zeros(4, 40, 3);

for s_id = 1:3
    targets(:,:,s_id) = [ones(1,10),  zeros(1,10), zeros(1,10), zeros(1,10);...
                         zeros(1,10), ones(1,10),  zeros(1,10), zeros(1,10);...
                         zeros(1,10), zeros(1,10), ones(1,10),  zeros(1,10);...
                         zeros(1,10), zeros(1,10), zeros(1,10), ones(1,10)];
end

% find (n,k) combinations of features
features_positions = [1:total_features];
C = nchoosek(features_positions,chosen_features_num);
nets_num = nchoosek(total_features, chosen_features_num);

% create input vectors
inputs = cell(1,3);
inputs{1} = zeros(4, 40, size(C,1));        %sensor #1
inputs{2} = zeros(4, 40, size(C,1));        %sensor #2
inputs{3} = zeros(4, 40, size(C,1));        %sensor #3

for s_id = 1:3
    for t_id = 1:size(C,1)
        for a_id = 1:4
            for v_id = 1:10
                for f_id = 1:chosen_features_num
                    inputs{s_id}(f_id, ((a_id-1) * 10) + v_id, t_id) = ...
                        dsgetfeature(features_ds, C(t_id, f_id), s_id, a_id, v_id);
                end
            end
        end
    end
end



%% sensor 1 networks
% create (n,k) neural networks and train them

neural_networks_1 = cell(1,nets_num);
results_nn_1 = cell(1,nets_num);
performance_nn_1 = cell(1,nets_num);

for i=1:nets_num
    neural_networks_1{i} = patternnet(10);
    neural_networks_1{i}.divideParam.trainRatio = 70/100;
    neural_networks_1{i}.divideParam.valRatio = 15/100;
    neural_networks_1{i}.divideParam.testRatio = 15/100;
    neural_networks_1{i} = train(neural_networks_1{i},inputs{1}(:,:,1), targets(:,:,1));
    results_nn_1{i} = neural_networks_1{i}(inputs{1}(:,:,1));
    performance_nn_1{i} = perform(neural_networks_1{i},targets(:,:,1),results_nn_1{i});
end

%% sensor 2 networks
% create (n,k) neural networks and train them

neural_networks_2 = cell(1,nets_num);
results_nn_2 = cell(1,nets_num);
performance_nn_2 = cell(1,nets_num);

for i=1:nets_num
    neural_networks_2{i} = patternnet(10);
    neural_networks_2{i}.divideParam.trainRatio = 70/100;
    neural_networks_2{i}.divideParam.valRatio = 15/100;
    neural_networks_2{i}.divideParam.testRatio = 15/100;
    neural_networks_2{i} = train(neural_networks_2{i},inputs{2}(:,:,1), targets(:,:,1));
    results_nn_2{i} = neural_networks_2{i}(inputs{2}(:,:,1));
    performance_nn_2{i} = perform(neural_networks_2{i},targets(:,:,1),results_nn_2{i});
end

%% sensor 3 networks
% create (n,k) neural networks and train them

neural_networks_3 = cell(1,nets_num);
results_nn_3 = cell(1,nets_num);
performance_nn_2 = cell(1,nets_num);

for i=1:nets_num
    neural_networks_2{i} = patternnet(10);
    neural_networks_2{i}.divideParam.trainRatio = 70/100;
    neural_networks_2{i}.divideParam.valRatio = 15/100;
    neural_networks_2{i}.divideParam.testRatio = 15/100;
    neural_networks_2{i} = train(neural_networks_2{i},inputs{2}(:,:,1), targets(:,:,1));
    results_nn_2{i} = neural_networks_2{i}(inputs{2}(:,:,1));
    performance_nn_2{i} = perform(neural_networks_2{i},targets(:,:,1),results_nn_2{i});
end


% net = patternnet(15);
% net = train(net, inputs(:,:,1), targets(:,:,1));
% view(net);
% y = net(inputs(:,:,1));
% perf = perform(net, targets(:,:,1), y);
